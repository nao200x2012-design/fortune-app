<!doctype html>
<html lang="ja" class="size-m">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>田橋 矢男無 の 占い</title>
<link rel="stylesheet" href="style.css"/>
</head>
<body class="premium"> 
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>
    <div class="shooting-star"></div>

    <div class="star-flicker"></div>
    <div class="star-flicker"></div>
    <div class="star-flicker"></div>
    <div class="star-flicker"></div>
    <div class="star-flicker"></div>
    <div class="star-flicker"></div>

    <div class="wrap">
    <div class="card">
      <div class="box">
        <div class="toolbar">
          <div class="seg" role="group" aria-label="文字サイズ">
            <button id="fs-s">小</button>
            <button id="fs-m" class="active">中</button>
            <button id="fs-l">大</button>
          </div>
          <label class="save-toggle"><input id="saveToggle" type="checkbox"> 入力を保存</label>
          <div class="seg" role="group" aria-label="モード">
            <button id="mode-hon" class="active">表モード</button>
            <button id="mode-ura">裏モード</button>
          </div>
        </div>

        <div class="title">
          <h1>
            <ruby>田<rt>た</rt></ruby><ruby>橋<rt>ばし</rt></ruby>
            <span class="sp"></span>
            <ruby>矢<rt>や</rt></ruby><ruby>男<rt>お</rt></ruby><ruby>無<rt>な</rt></ruby>
            <span class="sp"></span>の<span class="sp"></span>
            <ruby>占<rt>うら</rt></ruby>い
          </h1>
        </div>

        <div class="grid g4" style="margin-top:18px">
          <div>
            <label>生まれ年</label>
            <select id="year"></select>
          </div>
          <div>
            <label>月</label>
            <select id="month"></select>
          </div>
          <div>
            <label>日</label>
            <select id="day"></select>
          </div>
          <div>
            <label>性別</label>
            <select id="gender">
              <option value="男性">男性</option>
              <option value="女性">女性</option>
              <option value="その他">その他</option>
            </select>
          </div>

          <div class="col-2">
            <label>テーマ</label>
            <select id="theme">
              <option value="総運">総運</option>
              <option value="金運">金運</option>
              <option value="仕事運">仕事運</option>
              <option value="恋愛運">恋愛運</option>
              <option value="人間関係">人間関係</option>
              <option value="健康運">健康運</option>
            </select>
          </div>

          <div class="col-2">
            <label>占術（複数可／未選択ならミックス）</label>
            <div id="methods" class="methods">
              <label><input type="checkbox" value="四柱推命"> 四柱推命</label>
              <label><input type="checkbox" value="タロット"> タロット</label>
              <label><input type="checkbox" value="数秘術"> 数秘術</label>
              <label><input type="checkbox" value="動物占い"> 動物占い</label>
              <label><input type="checkbox" value="九星気学"> 九星気学</label>
              <label><input type="checkbox" value="西洋占星術"> 西洋占星術</label>
              <label id="sexualMethod" style="display:none;"><input type="checkbox" value="誘惑の秘術"> 誘惑の秘術</label>
              <label><input type="checkbox" value="ミックス"> ミックス</label>
            </div>
            <div class="hint">※ 何も選ばなければ「ミックス」扱いになります。</div>
          </div>

          <div class="col-2">
            <label>（任意）ベース情報</label>
            <input id="base" type="text" placeholder="例）転職を検討／出費が続く など"/>
          </div>
          <div class="col-2">
            <label>（任意）願い・条件</label>
            <input id="wish" type="text" placeholder="例）昇給したい／安定収入が欲しい／素敵な出会い など"/>
          </div>

          <div class="col-4">
            <button id="run" class="btn">占う！（結果を表示）</button>
            <div class="note">※クリックから数秒〜数十秒で表示されます</div>
          </div>
        </div>

        <div id="res" class="result"></div>

        <div id="bio" class="card cal-card" style="display:none">
          <h3 class="cal-title">✨ 2週間のラッキーバイオリズム ✨</h3>
          <div class="legend">
            <span class="badge b-star">⭐ 全体運が良い日</span>
            <span class="badge b-heart">❤️ 恋愛運が良い日</span>
            <span class="badge b-money">💰 金運が良い日</span>
            <span class="badge b-work">💼 仕事運が良い日</span>
            <span class="badge b-rest">🍀 休みの日（ゆっくり）</span>
          </div>
          <div class="weekbar"><span>日</span><span>月</span><span>火</span><span>水</span><span>木</span><span>金</span><span>土</span></div>
          <div id="days" class="grid14"></div>
          <div class="note">※ ⭐の日に行動すると良い結果につながりやすいです。</div>
        </div>

      </div>
      <div id="usage-meter" class="usage-meter" style="text-align:right; margin-top:10px;">
        本端末での利用回数：<span id="usage-count">0</span>回
      </div>
    </div>
    <div class="footer">© Tabashi-Yaona</div> </div>

<script>
/* ========= util ========= */
const $ =(s,p=document)=>p.querySelector(s);
const esc=s=>String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
function toYMD(d){const z=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
function addDays(d,n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
function today0(){const t=new Date(); t.setHours(0,0,0,0); return t;}

function beautifyParagraphs(txt){
  const raw = String(txt||"").trim();
  if(!raw) return "";
  // <br>タグと余計な改行コードを削除し、レポート形式の段落分けに強制する
  const processedTxt = raw.replace(/<br\s*\/?>/gi, " ").replace(/[\r\n]+/g, "\n");
  
  // 鑑定レポート本文が空欄になるのを防ぐため、最低限の段落分けを行う
  if (processedTxt.length > 900 || processedTxt.includes('宿命の魅惑力:')) {
      // 鑑定レポート項目を強調表示するためのカスタム処理
      const headers = ['宿命の魅惑力', '今日の異性運勢', 'ターゲット別戦略指針', '総括と結論'];
      let content = processedTxt;
      
      let html = '';
      
      // 各ヘッダーを起点としてテキストを分割し、個別の段落として扱う
      const sections = content.split(/(宿命の魅惑力:|今日の異性運勢:|ターゲット別戦略指針:|総括と結論:)/);
      
      let currentHeader = '';
      sections.forEach((segment, index) => {
          if (headers.some(h => segment.startsWith(h + ':'))) {
              currentHeader = segment.replace(':', '').trim();
          } else if (currentHeader && segment.trim().length > 0) {
              // ヘッダーが見つかった後の段落（本文）を処理
              html += `<p class="sec"><strong>${currentHeader}</strong>：${esc(segment.trim())}</p>`;
              currentHeader = ''; // 次のセグメントが本文であれば、前のヘッダーに結合するためリセット
          } else if (index === 0 && segment.trim().length > 0) {
              // 最初の前文（リード文）を処理
              html += `<p class="sec"><strong>鑑定概要</strong>：${esc(segment.trim())}</p>`;
          }
      });
      
      if (html === '') {
          // 何も抽出できなかった場合、全文を単一の段落として返す（最終フォールバック）
          // AIの出力（raw）がそのまま見えるようにする
          const errorMsg = "鑑定レポートの取得に失敗しました。本文が取得できませんでした。";
          if (raw.length > 50) {
            return `<p class="sec"><strong>エラー</strong>：${errorMsg}<br>AI出力の冒頭：${esc(raw.substring(0, 200))}</p>`;
          }
          return `<p class="sec"><strong>エラー</strong>：${errorMsg}</p>`;
      }
      return html;
  }
  
  // 通常の段落整形
  const sents = processedTxt.replace(/\s+/g," ").split(/(?<=。)/);
  const blocks=[]; let buf="";
  for(let i=0;i<sents.length;i++){
    buf+=sents[i];
    if(((i+1)%2===0)||sents[i].length>40){ blocks.push(buf.trim()); buf=""; }
  }
  if(buf.trim()) blocks.push(buf.trim());
  return blocks.map(p=>`<p class="sec">${esc(p)}</p>`).join("");
}


/* ========= font size ========= */
const mapSize={s:"size-s", m:"size-m", l:"size-l"};
function applySize(k){
  document.documentElement.classList.remove("size-s","size-m","size-l");
  document.documentElement.classList.add(mapSize[k]||"size-m");
  $("#fs-s").classList.toggle("active",k==="s");
  $("#fs-m").classList.toggle("active",k==="m");
  $("#fs-l").classList.toggle("active",k==="l");
  localStorage.setItem("fontSizeKey",k);
}
$("#fs-s").onclick=()=>applySize("s");
$("#fs-m").onclick=()=>applySize("m");
$("#fs-l").onclick=()=>applySize("l");
applySize(localStorage.getItem("fontSizeKey")||"m");

/* ========= birth selects (修正) ========= */

const elYear=document.getElementById("year");
const elMonth=document.getElementById("month");
const elDay=document.getElementById("day");

function initBirth(){
  const now=new Date(); const yNow=now.getFullYear();
  
  // 年の選択肢生成
  for(let y=yNow; y>=yNow-100; y--) elYear.append(new Option(String(y),String(y)));
  // 月の選択肢生成
  for(let m=1; m<=12; m++) elMonth.append(new Option(String(m),String(m)));
  
  // 年と月が変わった時に日を更新する関数
  function fillDays(){
    const y=Number(elYear.value), m=Number(elMonth.value);
    // 月の最終日を取得 (例: 2025年2月0日 -> 1月31日)
    const last=new Date(y,m,0).getDate(); 
    const keep=elDay.value;
    elDay.innerHTML="";
    for(let d=1; d<=last; d++) elDay.append(new Option(String(d),String(d)));
    // 変更前の値（keep）が新しい月の最終日を超えていなければ、その値を保持
    if(keep && Number(keep)<=last) elDay.value=keep;
    else elDay.value=String(Math.min(last, new Date().getDate()));
    
    updateSexualMethodVisibility();
  }
  
  elYear.addEventListener("change",fillDays);
  elMonth.addEventListener("change",fillDays);
  
  // 初期値設定 (誕生日を20年前の今日に設定)
  elYear.value=String(yNow-20);  
  elMonth.value=String(now.getMonth()+1); // 現在の月
  fillDays(); // 日の選択肢を生成
  elDay.value=String(now.getDate()); // 現在の日
}
// ページロード時に初期化を確実に実行
document.addEventListener("DOMContentLoaded", initBirth);
/* ========= birth selects 修正終わり ========= */


/* ========= age and sexual method control ========= */
function getAge(year, month, day) {
    const today = new Date();
    // month - 1でJavaScriptの0-indexedの月に合わせる
    const birthDate = new Date(year, month - 1, day);
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}
function updateSexualMethodVisibility() {
    const year = Number($("#year").value);
    const month = Number($("#month").value);
    const day = Number($("#day").value);
    const mode = document.body.dataset.mode;
    
    if (!year || !month || !day) return;
    
    const age = getAge(year, month, day);
    
    // 裏モードかつ20歳以上で表示
    const isAdultAndUra = age >= 20 && mode === "ura";
    const elSexual = $("#sexualMethod");
    if (elSexual) {
        elSexual.style.display = isAdultAndUra ? 'inline-flex' : 'none';
        if (!isAdultAndUra && elSexual.querySelector('input').checked) {
            // 条件を満たさない場合はチェックを外す
            elSexual.querySelector('input').checked = false;
        }
    }
}


/* ========= mode ========= */
const elSave=$("#saveToggle");
function setMode(mode){
  document.body.dataset.mode = mode==="ura"?"ura":"hon";
  $("#mode-hon").classList.toggle("active",document.body.dataset.mode==="hon");
  $("#mode-ura").classList.toggle("active",document.body.dataset.mode==="ura");
  updateSexualMethodVisibility();
  saveInputs();
}
$("#mode-hon").onclick=()=>setMode("hon");
$("#mode-ura").onclick=()=>setMode("ura");

/* ========= save/load ========= */
function getCheckedMethods(){
  return Array.from(document.querySelectorAll("#methods input:checked")).map(i=>i.value);
}
function saveInputs(){
  // 入力を保存する処理
  if(!elSave.checked) return;
  const data={
    year:$("#year").value, month:$("#month").value, day:$("#day").value,
    gender:$("#gender").value, theme:$("#theme").value,
    base:$("#base").value, wish:$("#wish").value,
    methods:getCheckedMethods(),
    mode:document.body.dataset.mode||"hon",
  };
  localStorage.setItem("fortunePref", JSON.stringify(data));
}
function loadInputs(){
  const raw=localStorage.getItem("fortunePref"); if(!raw) return;
  try{
    const o=JSON.parse(raw);
    
    // ロード時に日を再生成するロジックを修正
    const y=Number(o.year), m=Number(o.month); 
    if(y && m){
        const last=new Date(y,m,0).getDate();
        elDay.innerHTML=""; 
        for(let d=1; d<=last; d++) elDay.append(new Option(String(d),String(d)));
    }
    
    $("#year").value=o.year; 
    $("#month").value=o.month;
    $("#day").value=o.day;

    $("#gender").value=o.gender; $("#theme").value=o.theme;
    $("#base").value=o.base||""; $("#wish").value=o.wish||"";
    document.querySelectorAll("#methods input").forEach(i=>i.checked=o.methods?.includes(i.value));
    setMode(o.mode==="ura"?"ura":"hon");
    elSave.checked=true;
    
    document.body.classList.add("premium"); 
    updateSexualMethodVisibility();
  }catch(e){
      console.error("Failed to load inputs:", e);
      // ロードに失敗したら保存を無効化
      elSave.checked=false;
  }
}
// DOMContentLoaded後、initBirthの後にloadInputsを実行するため、initBirthの後に呼び出す
document.addEventListener("DOMContentLoaded", loadInputs);


/* ========= usage meter ========= */
const USAGE_KEY = "fortuneUsageCount";
let usageCount = Number(localStorage.getItem(USAGE_KEY)) || 0;
const elUsageCount = $("#usage-count");
if(elUsageCount){
    elUsageCount.textContent = usageCount;
}

function incrementUsageCount(){
    usageCount++;
    localStorage.setItem(USAGE_KEY, usageCount);
    if(elUsageCount) elUsageCount.textContent = usageCount;
}

/* ========= result renderers (全てプレミアムデザインに統一) ========= */
const adviceTitles = [
    {h: "❤️ 恋愛・対人運の指針", cls:"love"}, 
    {h: "💼 仕事・学業運の指針", cls:"work"}, 
    {h: "💰 金運・経済面の指針", cls:"money"}, 
    {h: "🏥 健康・生活習慣の指針", cls:"health"}, 
    {h: "✨ 精神・意識に関する指針", cls:"spirit"}
];


// 通常モードのレンダリング関数
function renderNormalResult(d){
    const title = esc(d.title||"鑑定レポート");
    const lead  = esc(d.lead || "今日の運勢は、あなたにとって重要な転機となるでしょう。");
    const overviewHtml = beautifyParagraphs(d.overview);

    // 5つのアドバイスをレンダリング
    const adviceHtml = d.advice?.map((adv, i) => {
        const info = adviceTitles[i] || {h: `アドバイス ${i+1}`, cls: 'spirit'};
        return `<div class="section ${info.cls}"><h4>${info.h}</h4><p class="sec">${esc(adv)}</p></div>`;
    }).join('');

    const warningsHtml = (d.warnings||[]).map(w => `<p class="sec">${esc(w)}</p>`).join('');
    
    const keywordsHtml = (d.keywords||[])
        .map(k => `<span class="chip">${esc(k)}</span>`)
        .join('');
        
    const chanceDaysHtml = (d.chance_days||[])
        .map(dateStr => {
            const date = new Date(dateStr);
            return `${date.getMonth()+1}/${date.getDate()} (${["日","月","火","水","木","金","土"][date.getDay()]})`;
        }).join('、');
        
    // 特化占術用のキー情報を取得・表示（例: タロットのキーカード）
    let specialInfoHtml = '';
    if (d.isSingleMethod) {
        if (d.key_card) {
            specialInfoHtml = `<div class="kpi" style="font-size:1rem; color:var(--love-text); border-color:var(--love-text);">キーカード: ${esc(d.key_card)}</div>`;
        } else if (d.my_star && d.goshin) {
             specialInfoHtml = `<div class="kpi">日干: ${esc(d.my_star)}</div><div class="kpi">五行: ${esc(d.goshin)}</div>`;
        } else if (d.honmei_sei) {
            specialInfoHtml = `<div class="kpi">本命星: ${esc(d.honmei_sei)}</div>`;
            if (d.getto_kibou) {
                specialInfoHtml += `<div class="kpi">今月の吉方: ${esc(d.getto_kibou)}</div>`;
            }
        }
    }

    return `
        <div class="result-hero">
            <div class="eyebrow">鑑定書</div>
            <div class="title-line">${title}</div>
            <div class="lead">${lead}</div>
        </div>

        <div class="section">
            <h4>📝 総合鑑定レポート</h4>
            ${overviewHtml}
        </div>
        
        <div class="kpi-row">
            <div class="kpi">ラッキーカラー: ${esc(d.lucky_color || "不明")}</div>
            <div class="kpi">ラッキーナンバー: ${esc(d.lucky_number || "不明")}</div>
            ${specialInfoHtml}
            ${chanceDaysHtml ? `<div class="kpi">運命の日: ${chanceDaysHtml}</div>` : ''}
        </div>

        ${adviceHtml}

        ${warningsHtml ? `<div class="section warn"><h4>⚠️ 注意すべきこと</h4>${warningsHtml}</div>` : ''}
        
        <div class="section">
            <h4>💡 キーワード＆アクション</h4>
            <div class="chips">${keywordsHtml || '（特になし）'}</div>
        </div>

        <div class="cta-row">
            <button class="cta" onclick="document.getElementById('bio').scrollIntoView({behavior:'smooth'})">バイオリズムで未来を確かめる</button>
        </div>
    `;
}

// バイオリズム描画関数
function renderBiorhythm(biorhythmData) {
    const elDays = $("#days");
    elDays.innerHTML = ""; // 初期化

    const today = today0(); // 本日0時のDateオブジェクト
    const dayNames = ["日", "月", "火", "水", "木", "金", "土"];

    biorhythmData.forEach((dayData) => {
        const date = new Date(dayData.date);
        const dayOfWeek = dayNames[date.getDay()];
        const dayClass = dayData.score >= 80 ? 's-good' : dayData.score >= 50 ? 's-mid' : 's-low';
        
        let emoji = '';
        if (date.getTime() < today.getTime()) {
             emoji = '✅'; // 過去の日付（本来は表示しないが、デバッグ用）
        } else if (date.toDateString() === today.toDateString()) {
             emoji = '▶️'; // 今日
        } else if (dayData.score >= 85) {
             emoji = '⭐'; // 非常に良い日
        } else if (dayData.score >= 70) {
             emoji = '👍'; // 良い日
        } else if (dayData.score >= 50) {
             emoji = '🙂'; // 普通の日
        } else {
             emoji = '💧'; // 低調な日
        }
        
        // 曜日ごとに色分けする（日曜日=赤、土曜日=青）
        const dayStyle = date.getDay() === 0 ? 'style="color:#ff6f6f;"' : date.getDay() === 6 ? 'style="color:#6496ff;"' : '';

        elDays.innerHTML += `
            <div class="cell">
                <div class="date" ${dayStyle}>${date.getMonth()+1}/${date.getDate()} (${dayOfWeek})</div>
                <div class="score ${dayClass}">${emoji} ${dayData.score}%</div>
            </div>
        `;
    });
}


// 誘惑の秘術専用の特別表示 (JSONデータを直接読み込む)
function renderSexualResult(d){
    const title = esc(d.title||"秘められた魅惑の鑑定");
    const lead  = esc(d.lead || "さあ、私と一緒に最高のゲームを始めましょう。");
    const overview = beautifyParagraphs(d.overview);
    
    // サーバーから送られてきたランキングデータを直接使用
    const rankings = d.sexualRankings || {};
    
    // フラットなキー名で直接アクセスしてレンダリング
    const renderList = (key) => {
        const items = rankings[key] || [];
        // 項目名が長いため、キーから余計な部分を取り除いて表示
        return items.length > 0 
            ? items.map(item => `<li>${esc(item)}</li>`).join('') 
            : '<li>（統計データが不足しています）</li>';
    };

    const time = esc(rankings.時間帯 || "非公開");
    
    const flirts = (rankings.口説き文句 || [])
        .map(f => `<span class="chip">${esc(f.trim().replace(/^[\-\*\d\.\)\s]*/, '').trim())}</span>`)
        .join('');
    
    // overviewの内容を、鑑定項目に分割
    const overviewSections = overview.split(/<p class="sec">/g).filter(s => s.trim() !== '');

    const reportContent = (header) => {
        // AIが項目名の後にコロン（:）を付けていることを利用して本文を抽出
        const match = overviewSections.find(s => s.startsWith(header));
        if (match) {
            // 太字の項目名とその後のコロンを除去して本文を抽出
            const body = match.replace(new RegExp(`^<strong>${header}</strong>：`), '').trim();
            // 改行を許容し、太字で項目名を強調
            return `<p class="sec"><strong>${header}</strong>：${body}</p>`;
        }
        return `<p class="sec"><strong>${header}</strong>：鑑定データが不足しています。</p>`;
    };

    // アドバイス（恋愛・対人運の指針）の最初の1件目のみを取得し、総括として使用
    const finalAdvice = esc((Array.isArray(d.advice) && d.advice.length > 0) ? d.advice[0] : "秘術は教えたわ。あとはあなたの手にかかっているわよ。フフッ。");
    
    return `
    <div class="result-hero" style="border-color:#ff99d0; background:radial-gradient(1000px 400px at 50% -10%, rgba(255,100,160,.3), rgba(255,100,160,0) 55%), linear-gradient(180deg, rgba(255,170,230,.08), rgba(255,170,230,.02))">
      <div class="eyebrow" style="color:#ff99d0;">魅惑の秘術：FINAL REPORT</div>
      <div class="title-line" style="background:linear-gradient(90deg,#ffd8f0,#ff99d0,#ffd8f0); -webkit-background-clip:text;">${title}</div>
      <div class="lead" style="color:#ff99d0;">${lead}</div>
    </div>

    <div class="section love">
      <h4>❤️ 今日のセクシャル運（鑑定レポート）</h4>
      
      <div class="report-content">
          ${reportContent('宿命の魅惑力')}
          ${reportContent('今日の異性運勢')}
          ${reportContent('ターゲット別戦略指針')}
          ${reportContent('総括と結論')}
      </div>
    </div>
    
    <div class="grid g4" style="margin-top:20px; grid-template-columns:1fr 1fr;">
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>💄 口紅の色 TOP3</h4>
                <ul style="margin:0;">${renderList('口紅の色')}</ul>
            </div>
        </div>
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>👙 下着の色 TOP3</h4>
                <ul style="margin:0;">${renderList('下着の色')}</ul>
            </div>
        </div>
        
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>👃 香水の系統 TOP3</h4>
                <ul style="margin:0;">${renderList('香水の系統')}</ul>
            </div>
        </div>
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>👀 視線の送り方 TOP3</h4>
                <ul style="margin:0;">${renderList('視線の送り方')}</ul>
            </div>
        </div>
        
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>👗 今日の勝負服 TOP3</h4>
                <ul style="margin:0;">${renderList('今日の勝負服（具体的アイテム）')}</ul>
            </div>
        </div>
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>💇‍♀️ 今日の勝負髪 TOP3</h4>
                <ul style="margin:0;">${renderList('今日の勝負髪（具体的スタイル）')}</ul>
            </div>
        </div>
        
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>💎 アクセサリー TOP3</h4>
                <ul style="margin:0;">${renderList('アクセサリー（宝石・金属）')}</ul>
            </div>
        </div>
        
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>📍 おすすめデート場所 TOP3</h4>
                <ul style="margin:0;">${renderList('おすすめデート場所')}</ul>
            </div>
        </div>
        <div class="col-2">
            <div class="section" style="padding:18px; border-color:var(--love-text); background:var(--love-bg);">
                <h4>🍽 おすすめご飯 TOP3</h4>
                <ul style="margin:0;">${renderList('おすすめご飯のジャンル')}</ul>
            </div>
        </div>
    </div>

    <div class="section" style="margin-top:12px;">
      <h4>⏱ 最高の運命を掴む時間</h4>
      <div class="kpi-row" style="margin-top:0;">
        <div class="kpi" style="color:#ff99d0; border-color:#ff99d0; background:rgba(255,153,208,.10); font-size:1.1rem;">最強の時間帯：${time}</div>
      </div>
    </div>
    
    <div class="section">
        <h4>💌 獲物を落とす最終口説き文句</h4>
        <div class="chips">${flirts}</div>
    </div>
    
    <div class="section love" style="border-color:#ff66b2; background:linear-gradient(180deg, rgba(255,179,202,.12), rgba(255,170,230,.3));">
        <h4>フフッ… 最後の仕上げよ</h4>
        <p class="sec" style="color:#ffb3ca;">${finalAdvice}</p>
    </div>
    
    <div class="cta-row">
      <button class="cta" onclick="document.getElementById('bio').scrollIntoView({behavior:'smooth'})">バイオリズムで未来を確かめる</button>
    </div>`;
}

/* ========= main logic - 占う処理と描画の統合 (修正・再追加) ========= */
const elRun = $("#run");
const elRes = $("#res");
const elBio = $("#bio");
const elDays = $("#days");

async function runFortune(){
    // 演出用の関数
    const setLoadMessage = (msg) => {
        elRes.innerHTML = `<p class='note' style="padding: 10px; font-size: 1rem; color: var(--accent); animation: pulse 1s infinite alternate;">${msg}</p>`;
    };
    
    // ロード中アニメーションのキーフレーム（CSSに依存しないインライン演出）
    if (!$('#pulse-style')) {
        const style = document.createElement('style');
        style.id = 'pulse-style';
        style.innerHTML = '@keyframes pulse { from { opacity: 0.6; } to { opacity: 1.0; } }';
        document.head.appendChild(style);
    }

    setLoadMessage("✨ 運命の星に接続中...（数秒お待ちください）");
    elBio.style.display = 'none'; // 新しい占いを開始する際にバイオリズムを非表示にする
    elDays.innerHTML = ''; 
    elRun.disabled = true;

    try{
        // 1. ユーザー入力の収集
        const birth = `${$("#year").value}-${String($("#month").value).padStart(2, '0')}-${String($("#day").value).padStart(2, '0')}`;
        const gender = $("#gender").value;
        const theme = $("#theme").value;
        const baseResult = $("#base").value;
        const wish = $("#wish").value;
        const methods = getCheckedMethods(); // 既存関数を使用
        const mode = document.body.dataset.mode;

        // ステップ1: データを送信する前の演出
        setLoadMessage("🔮 選択された占術で運命を解析中...");

        // 2. サーバーへPOSTリクエスト
        const response = await fetch('/fortune', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ birth, gender, theme, baseResult, wish, methods, mode })
        });

        if(!response.ok) {
             const errorText = await response.text();
             throw new Error("サーバーエラーが発生しました。HTTPステータス: " + response.status + " / 詳細: " + errorText.substring(0, 100));
        }
        
        const json = await response.json();
        
        // ステップ2: サーバーからの応答を待つ間の演出（レスポンスは来たがJSON解析前）
        setLoadMessage("📝 AIが鑑定レポートを作成中...（大運・小運を精査）");

        if(!json.ok) {
            // サーバー側でJSONパースエラーなどが発生した場合
            let errorMsg = "API処理中にエラーが発生しました";
            if(json.raw && json.raw.length > 50) {
                 errorMsg += `。AIの生の出力（デバッグ情報）の冒頭: ${esc(json.raw.substring(0, 200))}`;
            }
            throw new Error(errorMsg);
        }
        
        const d = json.data;
        const validData = d.title && d.overview && d.advice?.length > 0;
        
        if (!validData) {
             throw new Error(`鑑定レポートのデータが不完全です。AI出力に問題がある可能性があります。`);
        }

        // 3. 結果の描画
        if (d.isSexualActive) {
            elRes.innerHTML = renderSexualResult(d);
        } else {
            elRes.innerHTML = renderNormalResult(d);
        }

        // 4. バイオリズムの描画
        renderBiorhythm(d.biorhythm);
        elBio.style.display = 'block';

        // 5. 利用回数の更新
        incrementUsageCount(); // 既存関数を使用
        // 結果表示後にスクロール
        elRes.scrollIntoView({ behavior: 'smooth' });

    } catch(e) {
        console.error("占い処理エラー:", e);
        // エラーを赤字で大きく表示
        elRes.innerHTML = `<div class="result-hero" style="border-color:#ff6f6f; background:radial-gradient(1000px 400px at 50% -10%, rgba(255,100,100,.2), rgba(255,100,100,0) 55%);">
          <div class="eyebrow" style="color:#ff6f6f;">ERROR</div>
          <div class="title-line" style="background:linear-gradient(90deg,#ff8888,#ff6f6f,#ff8888); -webkit-background-clip:text;">鑑定失敗</div>
          <div class="lead" style="color:#ff6f6f;">${esc(e.message)}</div>
          <p class="sec" style="color:#ffc266; margin-top:10px;">（開発者向け：コンソールに詳細情報が出力されています）</p>
        </div>`;
        elBio.style.display = 'none';
    } finally {
        elRun.disabled = false;
    }
}

// ボタンにイベントを割り当て
elRun.onclick = runFortune;
</script>