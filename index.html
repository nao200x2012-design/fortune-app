<!doctype html>
<html lang="ja" class="size-m">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>田橋 矢男無 の 占い</title>
<style>
  :root{
    --bg:#0f2632; --panel:#163142; --panel2:#1c3a4f;
    --text:#e9f3f9; --muted:#bcd0dc; --accent:#ffbc40; --accent-d:#eea21a;
    --good:#6be59a; --warn:#ffc266;

    /* calendar */
    --panel-soft:#1b4256; --line:#2f5f75;
    --good2:#12d3b6; --mid2:#ffd266; --low2:#ff6f6f;
    --pastel1:#e8f7ff; --pastel2:#e9fff5; --pastel3:#fff6e1; --pastel4:#f6e9ff;
  }
  html.size-s { font-size: 14px; }
  html.size-m { font-size: 16px; }
  html.size-l { font-size: 18px; }

  *{ box-sizing:border-box; }
  body{
    margin:0; background:radial-gradient(1200px 600px at 50% -10%, #1b4358, #0a1c26 55%, #08141c 100%), #0f2632;
    color:var(--text); font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", "Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  .wrap{ max-width:960px; margin:40px auto; padding:0 18px; }
  .card{ background:linear-gradient(180deg, var(--panel), var(--panel2));
         border:1px solid rgba(255,255,255,0.06); border-radius:16px; box-shadow: 0 10px 26px rgba(0,0,0,.35); }
  .box{ padding:24px; }
  .title{ text-align:center; letter-spacing:.2em; font-weight:700; padding-top:24px; }
  h1{ margin:0; font-size:1.6rem; font-weight:900; letter-spacing:.35em; }
  .subline{ text-align:center; font-size:.8rem; color:var(--muted); margin-top:6px; }

  .toolbar{ display:flex; justify-content:flex-end; gap:8px; margin:8px 0 0; }
  .seg{ background:#0f2a39; border:1px solid rgba(255,255,255,.12); border-radius:10px; overflow:hidden; }
  .seg button{ background:transparent; color:var(--text); border:none; padding:.45rem .8rem; cursor:pointer; font-weight:700; }
  .seg button.active{ background:#163a51; }

  .grid{ display:grid; gap:12px; grid-template-columns: repeat(4, 1fr); }
  .grid .col-2{ grid-column: span 2; }
  .grid .col-3{ grid-column: span 3; }
  .grid .col-4{ grid-column: span 4; }

  label{ font-size:.8rem; color:var(--muted); display:block; margin:4px 2px 6px; }
  select, input[type="text"]{
    width:100%; background:#102836; border:1px solid rgba(255,255,255,.08); color:var(--text);
    padding:.6rem .75rem; border-radius:10px; outline:none; font-size:1rem;
  }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:4px; }

  .btn{
    display:block; width:100%; padding:.9rem 1.1rem; border-radius:12px;
    background:linear-gradient(180deg, var(--accent), var(--accent-d));
    color:#2d2200; font-weight:800; border:none; cursor:pointer; letter-spacing:.15em;
    box-shadow: 0 8px 18px rgba(255,188,64,.25); font-size:1.05rem;
  }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }
  .note{ text-align:center; font-size:.8rem; color:var(--muted); margin:8px 0 0; }

  .result{ margin-top:18px; }
  .res-title{ font-weight:900; font-size:1.2rem; margin:0 0 8px; }
  .lead{ color:var(--good); font-size:1rem; margin-bottom:10px; }
  .sec{ line-height:1.9; font-size:1rem; }
  .kvs{ display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
  .tag{ font-size:.85rem; color:#08222f; background:#9fd8ff; border-radius:999px; padding:.35rem .6rem; font-weight:700; }
  .pill{ font-size:.85rem; color:#0b2230; background:#b2f0cc; border-radius:999px; padding:.35rem .6rem; font-weight:800; }
  .bullet{ margin-top:12px; padding:12px; background:#0f2a39; border:1px dashed rgba(255,255,255,.08); border-radius:10px; }
  .alert{ background:#2a0f14; border:1px dashed rgba(255,180,170,.35); }
  .footer{ text-align:center; color:var(--muted); font-size:.75rem; padding:18px 0 24px; }

  /* 見出しだけルビ（上付き） */
  ruby{ ruby-position: over; }
  rt{ font-size:.65em; color:var(--muted); }

  /* ===== カレンダーの見た目 ===== */
  .cal{ margin-top:16px; }
  .cal-title{ font-weight:900; margin:0 0 8px; display:flex; gap:8px; align-items:center; }
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:4px 0 8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid rgba(255,255,255,.25)}
  .b-good{background:#c9ffe3;color:#064a3d}
  .b-mid {background:#fff1b9;color:#5a4300}
  .b-low {background:#ffd1d1;color:#7b1730}
  .weekbar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:8px 0}
  .weekbar span{font-size:12px;text-align:center;opacity:.95}
  .grid14{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .cell{position:relative;background:var(--panel2);border:1px solid rgba(255,255,255,.07);border-radius:14px;
    min-height:96px;padding:10px 10px 12px;box-shadow:0 6px 14px rgba(0,0,0,.15)}
  .flag{position:absolute;right:-4px;top:-6px;background:var(--pastel1);color:#134;font-weight:900;font-size:12px;
    padding:3px 8px;border-radius:10px 10px 10px 0;box-shadow:0 4px 10px rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.4)}
  .date{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin-bottom:6px;color:var(--muted)}
  .emoji{font-size:20px}
  .score{display:inline-flex;gap:6px;align-items:center;padding:5px 8px;border-radius:999px;font-weight:800;border:1px solid rgba(255,255,255,.18)}
  .s-good{background:rgba(18,211,182,.18);color:var(--good2)}
  .s-mid {background:rgba(255,210,102,.18);color:var(--mid2)}
  .s-low {background:rgba(255,111,111,.18);color:var(--low2)}
  .note{margin-top:8px;font-size:12px;opacity:.95}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="box">
        <!-- 文字サイズ：小/中/大 -->
        <div class="toolbar">
          <div class="seg" role="group" aria-label="文字サイズ">
            <button id="fs-s">小</button>
            <button id="fs-m" class="active">中</button>
            <button id="fs-l">大</button>
          </div>
        </div>

        <div class="title">
          <h1>
            <ruby>田<rt>た</rt></ruby><ruby>橋<rt>ばし</rt></ruby>
            <span style="margin:0 .2em;"></span>
            <ruby>矢<rt>や</rt></ruby><ruby>男<rt>お</rt></ruby><ruby>無<rt>な</rt></ruby>
            <span style="margin:0 .2em;"></span>の<span style="margin:0 .2em;"></span>
            <ruby>占<rt>うら</rt></ruby>い
          </h1>
          <div class="subline">（たばし やおな）</div>
        </div>

        <!-- 入力UI -->
        <div class="grid" style="margin-top:18px">
          <div>
            <label>生まれ年</label>
            <select id="year"></select>
          </div>
          <div>
            <label>月</label>
            <select id="month"></select>
          </div>
          <div>
            <label>日</label>
            <select id="day"></select>
          </div>
          <div>
            <label>性別</label>
            <select id="gender" style="color:#dfefff; font-weight:700;">
              <option value="男性">男性</option>
              <option value="女性">女性</option>
              <option value="その他">その他</option>
            </select>
          </div>

          <div class="col-2">
            <label>テーマ</label>
            <select id="theme">
              <option value="総運">総運</option>
              <option value="金運">金運</option>
              <option value="仕事運">仕事運</option>
              <option value="恋愛運">恋愛運</option>
              <option value="人間関係">人間関係</option>
              <option value="健康運">健康運</option>
            </select>
          </div>

          <div class="col-2">
            <label>占術（複数可 / 未選択ならミックス）</label>
            <div id="methods" style="display:flex; gap:10px; flex-wrap:wrap;">
              <label><input type="checkbox" value="四柱推命"> 四柱推命</label>
              <label><input type="checkbox" value="タロット"> タロット</label>
              <label><input type="checkbox" value="数秘術"> 数秘術</label>
              <label><input type="checkbox" value="動物占い"> 動物占い</label>
              <label><input type="checkbox" value="九星気学"> 九星気学</label>
              <label><input type="checkbox" value="西洋占星術"> 西洋占星術</label>
              <label><input type="checkbox" value="ミックス"> ミックス</label>
            </div>
            <div class="hint">※ 何も選ばなければ自動で「ミックス」扱いになります。</div>
          </div>

          <div class="col-2">
            <label>（任意）ベースになる出来事や気になること</label>
            <input id="base" type="text" placeholder="例）転職を検討／出費が続く／出会いが増えた など" />
          </div>
          <div class="col-2">
            <label>（任意）願い・条件</label>
            <input id="wish" type="text" placeholder="例）昇給したい／安定収入が欲しい／素敵な出会い など" />
          </div>

          <div class="col-4">
            <button id="run" class="btn">占う！（結果を表示）</button>
            <div class="note">※ クリックから数秒〜数十秒で表示されます</div>
          </div>
        </div>

        <!-- 結果 -->
        <div id="res" class="result"></div>

        <!-- 2週間カレンダー -->
        <div id="bio" class="card" style="margin-top:16px; display:none;">
          <div class="box cal">
            <div class="cal-title">✨ 2週間のラッキーバイオリズム ✨</div>
            <div class="legend">
              <span class="badge b-good">80〜100：とっても良い日 ⭐</span>
              <span class="badge b-mid">60〜79：まずまず</span>
              <span class="badge b-low">〜59：ゆっくり慎重に</span>
            </div>
            <div class="weekbar"><span>日</span><span>月</span><span>火</span><span>水</span><span>木</span><span>金</span><span>土</span></div>
            <div id="days" class="grid14"></div>
            <div class="note">※ ⭐の日はおすすめ。大事な予定や挑戦はこの日に寄せると吉。</div>
          </div>
        </div>

      </div>
    </div>
    <div class="footer">© Tanbashi-ya Onaa</div>
  </div>

<script>
  const $ = (s,p=document)=>p.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  /* ========== 文字サイズ切替 ========== */
  const mapSize = { s:"size-s", m:"size-m", l:"size-l" };
  function applySize(k){
    document.documentElement.classList.remove("size-s","size-m","size-l");
    document.documentElement.classList.add(mapSize[k]||"size-m");
    $("#fs-s").classList.toggle("active", k==="s");
    $("#fs-m").classList.toggle("active", k==="m");
    $("#fs-l").classList.toggle("active", k==="l");
    localStorage.setItem("fontSizeKey", k);
  }
  $("#fs-s").onclick = ()=>applySize("s");
  $("#fs-m").onclick = ()=>applySize("m");
  $("#fs-l").onclick = ()=>applySize("l");
  applySize(localStorage.getItem("fontSizeKey") || "m");

  /* ========== 生年月日プルダウン（閏年対応） ========== */
  const elYear=$("#year"), elMonth=$("#month"), elDay=$("#day");
  (function initBirth(){
    const now = new Date();
    const yNow = now.getFullYear();
    for(let y=yNow; y>=1900; y--) elYear.append(new Option(String(y), String(y)));
    for(let m=1; m<=12; m++) elMonth.append(new Option(String(m), String(m)));
    function fillDays(){
      const y=Number(elYear.value), m=Number(elMonth.value);
      const last = new Date(y, m, 0).getDate();
      const keep = elDay.value;
      elDay.innerHTML="";
      for(let d=1; d<=last; d++) elDay.append(new Option(String(d), String(d)));
      if (keep && Number(keep)<=last) elDay.value = keep;
    }
    elYear.addEventListener("change", fillDays);
    elMonth.addEventListener("change", fillDays);
    elYear.value = String(yNow);
    elMonth.value = String(now.getMonth()+1);
    fillDays();
    elDay.value = String(now.getDate());
  })();

  /* ========== 結果整形（段落化） ========== */
  function beautify(text){
    const raw = String(text || "").trim();
    if (!raw) return "";
    const sentences = raw.replace(/\s+/g," ").split(/(?<=。)/);
    const chunks = [];
    let buf = "";
    for (let i=0;i<sentences.length;i++){
      buf += sentences[i];
      const needBreak = ((i+1)%2===0) || sentences[i].length>40;
      if (needBreak){ chunks.push(buf.trim()); buf=""; }
    }
    if (buf.trim()) chunks.push(buf.trim());
    return chunks.map(p=>`<p class="sec">${esc(p)}</p>`).join("");
  }

  /* ========== バイオリズム用ユーティリティ ========== */
  function seedRand(seed){
    let x = seed|0; return ()=>{ x ^= x<<13; x ^= x>>>17; x ^= x<<5; return (x>>>0)/4294967295; };
  }
  function toYMD(d){const z=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
  function addDays(d, n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}

  function renderCalendar(bio){
    const daysWrap = $("#days"), bioCard = $("#bio");
    const weekday = s => new Date(`${s}T00:00:00`).getDay();
    const pad = weekday(bio[0].date);
    const emojiBy = s => s>=90?"🌟": s>=80?"🍀": s>=65?"😊": s>=50?"🫶":"🧸";
    const classBy = s => s>=80?"s-good": s>=60?"s-mid":"s-low";
    const pretty = s=>{ const d=new Date(`${s}T00:00:00`); return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,"0")}`; };

    daysWrap.innerHTML = (pad?`<div style="grid-column:span ${pad}"></div>`:"") + bio.map((x,i)=>{
      const s = Number(x.score||0), star = s>=80?"⭐":"";
      const pastel = [ "var(--pastel1)", "var(--pastel2)", "var(--pastel3)", "var(--pastel4)" ][ i % 4 ];
      return `
      <div class="cell" style="background:linear-gradient(180deg, ${pastel}1f, rgba(0,0,0,.12));">
        ${star?`<div class="flag">HAPPY ${star}</div>`:""}
        <div class="date"><span>${pretty(x.date)}</span><span class="emoji">${emojiBy(s)}</span></div>
        <div class="score ${classBy(s)}">スコア：${s}</div>
      </div>`;
    }).join("");
    const lastPad = (7 - ((pad + bio.length) % 7)) % 7;
    if(lastPad) daysWrap.insertAdjacentHTML("beforeend", `<div style="grid-column:span ${lastPad}"></div>`);
    bioCard.style.display = "";
  }

  /* ========== 占う！ ========== */
  const elRun=$("#run"), elRes=$("#res");
  const elTheme=$("#theme"), elGender=$("#gender"), elBase=$("#base"), elWish=$("#wish");

  function getMethods(){
    return Array.from(document.querySelectorAll("#methods input:checked")).map(i=>i.value);
  }

  elRun.addEventListener("click", async () => {
    try{
      elRun.disabled = true;
      elRun.textContent = "占い中…";
      elRes.innerHTML = "";
      $("#bio").style.display="none";
      $("#days").innerHTML="";

      const birth = `${year.value}-${String(month.value).padStart(2,"0")}-${String(day.value).padStart(2,"0")}`;
      const body = {
        birth,
        gender: elGender.value,
        theme: elTheme.value,
        baseResult: elBase.value,
        wish: elWish.value,
        methods: getMethods()
      };

      const r = await fetch("/fortune", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      const js = await r.json();
      if (!js.ok) throw new Error(js.error || "占いに失敗しました。");

      const d = js.data || {};
      const today = new Date(); today.setHours(0,0,0,0);

      // 未来日のみ（なければ 7/14/21日後を補完）
      let days = Array.isArray(d.chance_days) ? d.chance_days.filter(s=>{
        const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return true;
        const dt = new Date(+m[1], +m[2]-1, +m[3]);
        return dt > today;
      }) : [];
      if (days.length===0){
        const plus=[7,14,21];
        days = plus.map(n=>{ const t=new Date(today); t.setDate(t.getDate()+n);
          return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`; });
      }

      const title = esc(d.title || "運命の糸がほどけ、光が射す");
      const lead  = esc(d.lead  || "静かな追い風が、あなたを望む方角へ。");
      const over  = beautify(d.overview);

      const advice = (Array.isArray(d.advice)?d.advice:[]).map(x=>`<li>${esc(x)}</li>`).join("")
        || "<li>小さな改善を継続し、地に足をつけて進みましょう。</li>";

      const warns  = (Array.isArray(d.warnings)?d.warnings:[]).map(x=>`<li>${esc(x)}</li>`).join("");
      const kw = (Array.isArray(d.keywords)?d.keywords:[]).slice(0,6).map(k=>`<span class="tag">${esc(k)}</span>`).join("");

      const color = esc(d.lucky_color || "黄緑");
      const num   = esc(d.lucky_number || "7");
      const chance = days.map(s=>`<span class="pill">チャンスの日：${esc(s)}</span>`).join(" ");

      elRes.innerHTML = `
        <div class="card" style="margin-top:16px">
          <div class="box">
            <div class="res-title">${title}</div>
            <div class="lead">${lead}</div>
            <div>${over}</div>

            ${warns ? `
            <div class="bullet alert">
              <b>注意しておきたいこと</b>
              <ul class="list">${warns}</ul>
            </div>` : ""}

            <div class="bullet" style="margin-top:12px">
              <b>アドバイス</b>
              <ul class="list">${advice}</ul>
            </div>

            <div class="kvs" style="margin-top:12px">
              <span class="pill">ラッキーカラー：${color}</span>
              <span class="pill">ラッキーナンバー：${num}</span>
              ${chance}
            </div>

            ${kw ? `<div class="kvs" style="margin-top:8px">${kw}</div>` : ""}
          </div>
        </div>
      `;

      /* ===== バイオリズム（サーバー未返却でも必ず表示） ===== */
      let bio = Array.isArray(d.biorhythm) ? d.biorhythm.slice(0,14) : null;
      if(!bio || bio.length===0){
        // 誕生日 or 今日をシードに14日分（再現性あり）
        const base = body.birth ? new Date(body.birth) : new Date();
        const seed = (base.getFullYear()*101 + (base.getMonth()+1)*31 + base.getDate()) ^ (new Date()).getDate()*97;
        const rnd = seedRand(seed);
        const today2 = new Date(); today2.setHours(0,0,0,0);
        bio = Array.from({length:14},(_,i)=>{
          const date = toYMD(addDays(today2,i));
          const core = 55 + Math.floor(rnd()*45); // 55〜99
          const wave = Math.round(12*Math.sin((i/3)*Math.PI)); // ゆらぎ
          let score = Math.max(35, Math.min(100, core + wave));
          return { date, score };
        });
      }
      renderCalendar(bio);

    }catch(e){
      elRes.innerHTML = `
        <div class="card" style="margin-top:16px">
          <div class="box">
            <div class="lead" style="color:var(--warn)">通信に失敗しました。</div>
            <pre class="sec" style="white-space:pre-wrap">${esc(e.message || e)}</pre>
          </div>
        </div>
      `;
    }finally{
      elRun.disabled = false;
      elRun.textContent = "占う！（結果を表示）";
    }
  });

  // フォントサイズ初期化
  (function(){ applySize(localStorage.getItem("fontSizeKey") || "m"); })();
</script>
</body>
</html>
