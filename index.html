
<!doctype html>
<html lang="ja" class="size-m">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ç”°æ©‹ çŸ¢ç”·ç„¡ ã® å ã„</title>
<style>
  :root{
    --bg:#0f2632; --panel:#163142; --panel2:#1c3a4f;
    --text:#e9f3f9; --muted:#bcd0dc; --accent:#ffbc40; --accent-d:#eea21a;
    --good:#6be59a; --warn:#ffc266;
    --pastel1:#e8f7ff; --pastel2:#e9fff5; --pastel3:#fff6e1; --pastel4:#f6e9ff;
    --line:#2f5f75;
  }
  html.size-s { font-size: 14px; }
  html.size-m { font-size: 16px; }
  html.size-l { font-size: 18px; }

  *{ box-sizing:border-box; }
  html, body{ margin:0; padding:0; background:var(--bg); color:var(--text); }
  body{
    font-family:"Yu Gothic","Hiragino Kaku Gothic ProN","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    line-height:1.75;
    -webkit-text-size-adjust:100%;
  }
  .wrap{ max-width:980px; margin:40px auto; padding:0 18px; }
  .card{ background:linear-gradient(180deg, var(--panel), var(--panel2));
         border:1px solid rgba(255,255,255,0.06); border-radius:16px; box-shadow:0 10px 26px rgba(0,0,0,.35); }
  .box{ padding:24px; }
  .title{ text-align:center; letter-spacing:.2em; font-weight:700; padding-top:8px; }
  h1{ margin:0; font-size:1.6rem; font-weight:900; letter-spacing:.35em; }
  .subline{ text-align:center; font-size:.85rem; color:var(--muted); margin-top:6px; }

  .toolbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin:8px 0 0; flex-wrap:wrap }
  .seg{ background:#0f2a39; border:1px solid rgba(255,255,255,.12); border-radius:10px; overflow:hidden; }
  .seg button{ background:transparent; color:var(--text); border:none; padding:.45rem .8rem; cursor:pointer; font-weight:700; }
  .seg button.active{ background:#163a51; }

  .grid{ display:grid; gap:12px; grid-template-columns: repeat(4, 1fr); }
  .grid .col-2{ grid-column: span 2; }
  .grid .col-3{ grid-column: span 3; }
  .grid .col-4{ grid-column: span 4; }

  label{ font-size:.85rem; color:var(--muted); display:block; margin:4px 2px 6px; }
  select, input[type="text"]{
    width:100%; background:#102836; border:1px solid rgba(255,255,255,.1); color:var(--text);
    padding:.65rem .75rem; border-radius:10px; outline:none; font-size:1rem;
  }
  .hint{ font-size:.8rem; color:var(--muted); margin-top:4px; }

  .btn{
    display:block; width:100%; padding:.9rem 1.1rem; border-radius:12px;
    background:linear-gradient(180deg, var(--accent), var(--accent-d));
    color:#2d2200; font-weight:800; border:none; cursor:pointer; letter-spacing:.15em;
    box-shadow: 0 8px 18px rgba(255,188,64,.25); font-size:1.05rem;
  }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }
  .note{ text-align:center; font-size:.8rem; color:var(--muted); margin:8px 0 0; }

  .result{ margin-top:18px; }
  .res-title{ font-weight:900; font-size:1.2rem; margin:0 0 8px; }
  .lead{ color:var(--good); font-size:1rem; margin-bottom:10px; }
  .sec{ line-height:1.9; font-size:1rem; }
  .kvs{ display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
  .tag{ font-size:.85rem; color:#08222f; background:#9fd8ff; border-radius:999px; padding:.35rem .6rem; font-weight:700; }
  .pill{ font-size:.85rem; color:#0b2230; background:#b2f0cc; border-radius:999px; padding:.35rem .6rem; font-weight:800; }
  .bullet{ margin-top:12px; padding:12px; background:#0f2a39; border:1px dashed rgba(255,255,255,.08); border-radius:10px; }
  .alert{ background:#2a0f14; border:1px dashed rgba(255,180,170,.35); }
  ruby{ ruby-position: over; }
  rt{ font-size:.65em; color:var(--muted); }

  .footer{ text-align:center; color:var(--muted); font-size:.75rem; padding:18px 0 24px; }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†UI */
  .profbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .profbar input[type="text"]{ width:auto; min-width:140px; }
  .btn-min{ padding:.45rem .7rem; font-size:.9rem; border-radius:10px; border:none; cursor:pointer; font-weight:800; background:#24506a; color:#dff4ff }
  .btn-del{ background:#6a2433; color:#ffe3ea }
  .label-inline{ display:flex; align-items:center; gap:6px; color:var(--muted); font-size:.85rem }
  .t-muted{ color:var(--muted); font-size:.8rem }

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå¯è¦–æ€§ï¼†ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ï¼‰ */
  .cal-card{background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px dashed rgba(255,255,255,.22); margin-top:16px}
  .cal-title{display:flex;align-items:center;gap:8px;margin:0 0 8px;font-weight:900}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin:4px 0 8px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid rgba(255,255,255,.25)}
  .weekbar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin:8px 0}
  .weekbar span{font-size:12px;text-align:center;opacity:.95}
  .grid14{display:grid;grid-template-columns:repeat(7, minmax(0,1fr));gap:8px}
  .cell{position:relative;background:#1b4256;border:1px solid var(--line);border-radius:14px;
    min-height:96px;padding:10px 10px 12px;box-shadow:0 6px 14px rgba(0,0,0,.15)}
  .flag{position:absolute;right:-4px;top:-6px;background:#fff;color:#134;font-weight:900;font-size:12px;
    padding:3px 8px;border-radius:10px 10px 10px 0;box-shadow:0 4px 10px rgba(0,0,0,.15);border:1px solid rgba(255,255,255,.4)}
  .date{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin-bottom:6px;color:var(--muted)}
  .emoji{font-size:20px}
  .score{display:inline-flex;gap:6px;align-items:center;padding:5px 8px;border-radius:999px;font-weight:800;border:1px solid rgba(255,255,255,.18)}
  .s-good{background:rgba(18,211,182,.18);color:var(--good)}
  .s-mid {background:rgba(255,210,102,.18);color:#ffd266}
  .s-low {background:rgba(255,111,111,.18);color:#ff9a9a}
  .icon{font-size:18px;margin-left:6px}

  /* --- ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– --- */
  @media (max-width: 640px){
    .wrap{ margin:20px auto; padding:0 12px; }
    .box{ padding:16px; }
    h1{ font-size:1.35rem; letter-spacing:.25em; }
    .grid{ grid-template-columns: repeat(2, 1fr); }
    .grid .col-2, .grid .col-3, .grid .col-4{ grid-column: span 2; }
    .weekbar{ gap:4px; }
    .grid14{ gap:4px; }
    .cell{ min-height:78px; padding:8px; border-radius:12px; }
    .date{ font-size:12px; }
    .emoji{ font-size:18px; }
    .score{ padding:4px 6px; font-size:.9rem; }
    .legend .badge{ font-size:11px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="box">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="toolbar">
          <!-- æ–‡å­—ã‚µã‚¤ã‚º -->
          <div class="seg" role="group" aria-label="æ–‡å­—ã‚µã‚¤ã‚º">
            <button id="fs-s">å°</button>
            <button id="fs-m" class="active">ä¸­</button>
            <button id="fs-l">å¤§</button>
          </div>

          <!-- ãƒˆãƒ¼ãƒ³åˆ‡æ›¿ï¼šè¡¨ / è£ -->
          <div class="tone" aria-label="ãƒˆãƒ¼ãƒ³åˆ‡æ›¿" style="display:flex;gap:8px;align-items:center">
            <span class="t-muted">ğŸ­ ãƒ¢ãƒ¼ãƒ‰ï¼š</span>
            <div class="seg">
              <button id="tone-omote" class="active" title="ã‚„ã•ã—ã‚ãƒ»ç©ã‚„ã‹">è¡¨ãƒ¢ãƒ¼ãƒ‰</button>
              <button id="tone-ura" title="ã‚ºãƒãƒƒã¨å¤§é˜ªã®ãŠã°ã¡ã‚ƒã‚“">è£ãƒ¢ãƒ¼ãƒ‰</button>
            </div>
          </div>

          <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†ï¼ˆç«¯æœ«ä¿å­˜ï¼‰ -->
          <div class="profbar" aria-label="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†ï¼ˆç«¯æœ«ä¿å­˜ï¼‰">
            <span class="t-muted">ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼š</span>
            <select id="profSelect" title="ä¿å­˜æ¸ˆã¿ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«"></select>
            <input id="profName" type="text" placeholder="æ–°è¦åï¼ˆä¾‹ï¼šãŸã‚ã†ï¼‰"/>
            <button id="profSave" class="btn-min">ä¿å­˜/æ›´æ–°</button>
            <button id="profDelete" class="btn-min btn-del">å‰Šé™¤</button>
            <label class="label-inline"><input type="checkbox" id="autoLoad"/> æ¬¡å›è‡ªå‹•ã§èª­ã¿è¾¼ã‚€</label>
          </div>
        </div>

        <div class="title">
          <h1>
            <ruby>ç”°<rt>ãŸ</rt></ruby><ruby>æ©‹<rt>ã°ã—</rt></ruby>
            <span style="margin:0 .2em;"></span>
            <ruby>çŸ¢<rt>ã‚„</rt></ruby><ruby>ç”·<rt>ãŠ</rt></ruby><ruby>ç„¡<rt>ãª</rt></ruby>
            <span style="margin:0 .2em;"></span>ã®<span style="margin:0 .2em;"></span>
            <ruby>å <rt>ã†ã‚‰</rt></ruby>ã„
          </h1>
          <div class="subline">ï¼ˆãŸã°ã— ã‚„ãŠãªï¼‰</div>
        </div>

        <!-- å…¥åŠ›UI -->
        <div class="grid" style="margin-top:18px">
          <div>
            <label>ç”Ÿã¾ã‚Œå¹´</label>
            <select id="year"></select>
          </div>
          <div>
            <label>æœˆ</label>
            <select id="month"></select>
          </div>
          <div>
            <label>æ—¥</label>
            <select id="day"></select>
          </div>
          <div>
            <label>æ€§åˆ¥</label>
            <select id="gender" style="color:#dfefff; font-weight:700;">
              <option value="ç”·æ€§">ç”·æ€§</option>
              <option value="å¥³æ€§">å¥³æ€§</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>

          <div class="col-2">
            <label>ãƒ†ãƒ¼ãƒ</label>
            <select id="theme">
              <option value="ç·é‹">ç·é‹</option>
              <option value="é‡‘é‹">é‡‘é‹</option>
              <option value="ä»•äº‹é‹">ä»•äº‹é‹</option>
              <option value="æ‹æ„›é‹">æ‹æ„›é‹</option>
              <option value="äººé–“é–¢ä¿‚">äººé–“é–¢ä¿‚</option>
              <option value="å¥åº·é‹">å¥åº·é‹</option>
            </select>
          </div>

          <div class="col-2">
            <label>å è¡“ï¼ˆè¤‡æ•°å¯ / æœªé¸æŠãªã‚‰ãƒŸãƒƒã‚¯ã‚¹ï¼‰</label>
            <div id="methods" style="display:flex; gap:10px; flex-wrap:wrap;">
              <label><input type="checkbox" value="å››æŸ±æ¨å‘½"> å››æŸ±æ¨å‘½</label>
              <label><input type="checkbox" value="ã‚¿ãƒ­ãƒƒãƒˆ"> ã‚¿ãƒ­ãƒƒãƒˆ</label>
              <label><input type="checkbox" value="æ•°ç§˜è¡“"> æ•°ç§˜è¡“</label>
              <label><input type="checkbox" value="å‹•ç‰©å ã„"> å‹•ç‰©å ã„</label>
              <label><input type="checkbox" value="ä¹æ˜Ÿæ°—å­¦"> ä¹æ˜Ÿæ°—å­¦</label>
              <label><input type="checkbox" value="è¥¿æ´‹å æ˜Ÿè¡“"> è¥¿æ´‹å æ˜Ÿè¡“</label>
              <label><input type="checkbox" value="ãƒŸãƒƒã‚¯ã‚¹"> ãƒŸãƒƒã‚¯ã‚¹</label>
            </div>
            <div class="hint">â€» ä½•ã‚‚é¸ã°ãªã‘ã‚Œã°è‡ªå‹•ã§ã€ŒãƒŸãƒƒã‚¯ã‚¹ã€æ‰±ã„ã«ãªã‚Šã¾ã™ã€‚</div>
          </div>

          <div class="col-2">
            <label>ï¼ˆä»»æ„ï¼‰ãƒ™ãƒ¼ã‚¹ã«ãªã‚‹å‡ºæ¥äº‹ã‚„æ°—ã«ãªã‚‹ã“ã¨</label>
            <input id="base" type="text" placeholder="ä¾‹ï¼‰è»¢è·ã‚’æ¤œè¨ï¼å‡ºè²»ãŒç¶šãï¼å‡ºä¼šã„ãŒå¢—ãˆãŸ ãªã©" />
          </div>
          <div class="col-2">
            <label>ï¼ˆä»»æ„ï¼‰é¡˜ã„ãƒ»æ¡ä»¶</label>
            <input id="wish" type="text" placeholder="ä¾‹ï¼‰æ˜‡çµ¦ã—ãŸã„ï¼å®‰å®šåå…¥ãŒæ¬²ã—ã„ï¼ç´ æ•µãªå‡ºä¼šã„ ãªã©" />
          </div>

          <div class="col-4">
            <button id="run" class="btn">å ã†ï¼ï¼ˆçµæœã‚’è¡¨ç¤ºï¼‰</button>
            <div class="note">â€» ã‚¯ãƒªãƒƒã‚¯ã‹ã‚‰æ•°ç§’ã€œæ•°åç§’ã§è¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
        </div>

        <!-- çµæœ -->
        <div id="res" class="result"></div>

        <!-- 2é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div id="bio" class="card cal-card" style="display:none">
          <h3 class="cal-title">âœ¨ 2é€±é–“ã®ãƒ©ãƒƒã‚­ãƒ¼ãƒã‚¤ã‚ªãƒªã‚ºãƒ  âœ¨</h3>
          <div class="legend">
            <span class="badge">â­ å…¨ä½“é‹ãŒè‰¯ã„æ—¥</span>
            <span class="badge">â¤ï¸ æ‹æ„›é‹ãŒè‰¯ã„æ—¥</span>
            <span class="badge">ğŸ’° é‡‘é‹ãŒè‰¯ã„æ—¥</span>
            <span class="badge">ğŸ’¼ ä»•äº‹é‹ãŒè‰¯ã„æ—¥</span>
            <span class="badge">â˜˜ï¸ ä¼‘ã¿ã®æ—¥ï¼ˆã‚†ã£ãã‚Šï¼‰</span>
          </div>
          <div class="weekbar"><span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span></div>
          <div id="days" class="grid14"></div>
          <div class="note">â€» â­ã®æ—¥ã¯ç·åˆçš„ã«ãŠã™ã™ã‚ã€‚äºˆå®šã‚„æŒ‘æˆ¦ã¯ã“ã“ã«å¯„ã›ã‚‹ã¨å‰ã€‚</div>
        </div>

      </div>
    </div>
    <div class="footer">Â© Tanbashi-ya Onaa</div>
  </div>

<script>
  const $ = (s,p=document)=>p.querySelector(s);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

  /* ===== æ–‡å­—ã‚µã‚¤ã‚º ===== */
  const mapSize = { s:"size-s", m:"size-m", l:"size-l" };
  function applySize(k){
    document.documentElement.classList.remove("size-s","size-m","size-l");
    document.documentElement.classList.add(mapSize[k]||"size-m");
    $("#fs-s").classList.toggle("active", k==="s");
    $("#fs-m").classList.toggle("active", k==="m");
    $("#fs-l").classList.toggle("active", k==="l");
    localStorage.setItem("fontSizeKey", k);
  }
  $("#fs-s").onclick = ()=>applySize("s");
  $("#fs-m").onclick = ()=>applySize("m");
  $("#fs-l").onclick = ()=>applySize("l");
  applySize(localStorage.getItem("fontSizeKey") || "m");

  /* ===== ãƒˆãƒ¼ãƒ³åˆ‡æ›¿ï¼šè¡¨/è£ ===== */
  let tone = localStorage.getItem("fortuneTone") || "normal"; // normal / ura
  function applyToneUI(){
    $("#tone-omote").classList.toggle("active", tone==="normal");
    $("#tone-ura").classList.toggle("active", tone==="ura");
  }
  $("#tone-omote").onclick = ()=>{ tone="normal"; localStorage.setItem("fortuneTone", tone); applyToneUI(); };
  $("#tone-ura").onclick    = ()=>{ tone="ura";    localStorage.setItem("fortuneTone", tone); applyToneUI(); };
  applyToneUI();

  /* ===== ç”Ÿå¹´æœˆæ—¥ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆé–å¹´å¯¾å¿œï¼‰ ===== */
  const elYear=$("#year"), elMonth=$("#month"), elDay=$("#day");
  (function initBirth(){
    const now = new Date();
    const yNow = now.getFullYear();
    for(let y=yNow; y>=1900; y--) elYear.append(new Option(String(y), String(y)));
    for(let m=1; m<=12; m++) elMonth.append(new Option(String(m), String(m)));
    function fillDays(){
      const y=Number(elYear.value), m=Number(elMonth.value);
      const last = new Date(y, m, 0).getDate();
      const keep = elDay.value;
      elDay.innerHTML="";
      for(let d=1; d<=last; d++) elDay.append(new Option(String(d), String(d)));
      if (keep && Number(keep)<=last) elDay.value = keep;
    }
    elYear.addEventListener("change", fillDays);
    elMonth.addEventListener("change", fillDays);
    elYear.value = String(yNow);
    elMonth.value = String(now.getMonth()+1);
    fillDays();
    elDay.value = String(now.getDate());
  })();

  /* ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ï¼ˆlocalStorageï¼‰ ===== */
  const LS_KEY = "fortuneProfiles:v1";
  const LS_AUTO = "fortuneAutoLoadName";

  const elProfSelect = $("#profSelect");
  const elProfName   = $("#profName");
  const elProfSave   = $("#profSave");
  const elProfDelete = $("#profDelete");
  const elAutoLoad   = $("#autoLoad");

  function loadProfiles(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
    catch{ return {}; }
  }
  function saveProfiles(obj){
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }
  function refreshProfSelect(selectedName){
    const profs = loadProfiles();
    elProfSelect.innerHTML = "";
    elProfSelect.append(new Option("ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰", ""));
    Object.keys(profs).sort().forEach(name=>{
      const o = new Option(name, name);
      if (selectedName && name===selectedName) o.selected = true;
      elProfSelect.append(o);
    });
  }
  function getCurrentInput(){
    return {
      name: elProfName.value.trim(),
      year: $("#year").value,
      month: $("#month").value,
      day: $("#day").value,
      gender: $("#gender").value,
      theme: $("#theme").value,
      methods: Array.from(document.querySelectorAll("#methods input:checked")).map(i=>i.value)
    };
  }
  function setInputs(p){
    if (!p) return;
    if (p.year)  $("#year").value  = String(p.year);
    if (p.month) { $("#month").value = String(p.month); $("#month").dispatchEvent(new Event("change")); }
    if (p.day)   $("#day").value   = String(p.day);
    if (p.gender) $("#gender").value = p.gender;
    if (p.theme)  $("#theme").value  = p.theme;
    document.querySelectorAll("#methods input[type=checkbox]").forEach(chk=>{
      chk.checked = Array.isArray(p.methods) ? p.methods.includes(chk.value) : false;
    });
  }

  elProfSave.addEventListener("click", ()=>{
    const p = getCurrentInput();
    if (!p.name){ alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šãŸã‚ã†ï¼‰"); elProfName.focus(); return; }
    const profs = loadProfiles();
    profs[p.name] = p;
    saveProfiles(profs);
    refreshProfSelect(p.name);
    if (elAutoLoad.checked) localStorage.setItem(LS_AUTO, p.name);
    alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã ã‘ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚");
  });

  elProfDelete.addEventListener("click", ()=>{
    const name = elProfSelect.value || elProfName.value.trim();
    if (!name){ alert("å‰Šé™¤ã™ã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
    const profs = loadProfiles();
    if (!profs[name]){ alert("ãã®åå‰ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚"); return; }
    if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    delete profs[name];
    saveProfiles(profs);
    refreshProfSelect("");
    if (localStorage.getItem(LS_AUTO)===name) localStorage.removeItem(LS_AUTO);
    alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
  });

  elProfSelect.addEventListener("change", ()=>{
    const name = elProfSelect.value;
    if (!name) return;
    const profs = loadProfiles();
    const p = profs[name];
    if (p){ setInputs(p); elProfName.value = name; }
  });

  elAutoLoad.addEventListener("change", ()=>{
    const name = elProfSelect.value || elProfName.value.trim();
    if (elAutoLoad.checked){
      if (!name){ alert("è‡ªå‹•èª­è¾¼ã«ã™ã‚‹ã«ã¯ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«åã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); elAutoLoad.checked=false; return; }
      localStorage.setItem(LS_AUTO, name);
      alert(`æ¬¡å›ã‹ã‚‰ã€Œ${name}ã€ã‚’è‡ªå‹•ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚`);
    }else{
      localStorage.removeItem(LS_AUTO);
    }
  });

  (function initProfiles(){
    refreshProfSelect("");
    const autoName = localStorage.getItem(LS_AUTO);
    if (autoName){
      const profs = loadProfiles();
      if (profs[autoName]){ setInputs(profs[autoName]); elProfName.value = autoName; refreshProfSelect(autoName); elAutoLoad.checked = true; }
    }
  })();

  /* ===== çµæœæ•´å½¢ ===== */
  function beautify(text){
    const raw = String(text || "").trim();
    if (!raw) return "";
    const sentences = raw.replace(/\s+/g," ").split(/(?<=ã€‚)/);
    const chunks = [];
    let buf = "";
    for (let i=0;i<sentences.length;i++){
      buf += sentences[i];
      const needBreak = ((i+1)%2===0) || sentences[i].length>40;
      if (needBreak){ chunks.push(buf.trim()); buf=""; }
    }
    if (buf.trim()) chunks.push(buf.trim());
    return chunks.map(p=>`<p class="sec">${esc(p)}</p>`).join("");
  }

  /* ===== ãƒã‚¤ã‚ªãƒªã‚ºãƒ ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ5ã‚¢ã‚¤ã‚³ãƒ³åˆ¤å®šä»˜ãï¼‰ ===== */
  const daysWrap=$("#days"), bioCard=$("#bio");
  function seedRand(seed){ let x = seed|0; return ()=>{ x^=x<<13; x^=x>>>17; x^=x<<5; return (x>>>0)/4294967295; }; }
  function toYMD(d){const z=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
  function addDays(d, n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
  function dayOfWeek(ymd){ return new Date(`${ymd}T00:00:00`).getDay(); }

  // å„ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢ç”Ÿæˆï¼šèª•ç”Ÿæ—¥ï¼‹ã‚ªãƒ•ã‚»ãƒƒãƒˆã§å†ç¾æ€§ã‚’æ‹…ä¿
  function scoreFactory(birth, offset){
    const base = birth ? new Date(birth) : new Date();
    const seed = (base.getFullYear()*101 + (base.getMonth()+1)*31 + base.getDate()) ^ offset;
    const rnd = seedRand(seed);
    return (i)=>{ // i æ—¥ç›®
      const core = 55 + Math.floor(rnd()*45); // 55ã€œ99
      const wave = Math.round(12*Math.sin(((i+offset/7)/3)*Math.PI));
      return Math.max(35, Math.min(100, core + wave));
    };
  }

  // ã‚¢ã‚¤ã‚³ãƒ³æ±ºå®šï¼šâ­(overall>=85) ï¼ é€±æœ«â˜˜ï¸ ï¼ æœ€å¤§ã‚«ãƒ†ã‚´ãƒªï¼ˆâ¤ï¸/ğŸ’°/ğŸ’¼ï¼‰
  function pickIcon(ymd, sAll, sLove, sMoney, sWork){
    const wd = dayOfWeek(ymd);
    if (sAll >= 85) return { icon:"â­", label:"å…¨ä½“é‹ãŒè‰¯ã„æ—¥" };
    if (wd === 0 || wd === 6) return { icon:"â˜˜ï¸", label:"ä¼‘ã¿ã®æ—¥ï¼ˆã‚†ã£ãã‚Šï¼‰" };
    // æœ€å¤§ã‚«ãƒ†ã‚´ãƒª
    const entries = [
      {k:"love", v:sLove, icon:"â¤ï¸", label:"æ‹æ„›é‹ãŒè‰¯ã„æ—¥"},
      {k:"money", v:sMoney, icon:"ğŸ’°", label:"é‡‘é‹ãŒè‰¯ã„æ—¥"},
      {k:"work", v:sWork, icon:"ğŸ’¼", label:"ä»•äº‹é‹ãŒè‰¯ã„æ—¥"}
    ];
    entries.sort((a,b)=>b.v-a.v);
    return { icon: entries[0].icon, label: entries[0].label };
  }

  /* ===== å ã†ï¼ ===== */
  const elRun=$("#run"), elRes=$("#res");
  const elTheme=$("#theme"), elGender=$("#gender"), elBase=$("#base"), elWish=$("#wish");

  function getMethods(){
    return Array.from(document.querySelectorAll("#methods input:checked")).map(i=>i.value);
  }

  elRun.addEventListener("click", async () => {
    try{
      elRun.disabled = true;
      elRun.textContent = "å ã„ä¸­â€¦";
      elRes.innerHTML = "";
      bioCard.style.display="none"; daysWrap.innerHTML="";

      const birth = `${year.value}-${String(month.value).padStart(2,"0")}-${String(day.value).padStart(2,"0")}`;
      const body = {
        birth,
        gender: elGender.value,
        theme: elTheme.value,
        baseResult: elBase.value,
        wish: elWish.value,
        methods: getMethods(),
        tone // normal / ura
      };

      const r = await fetch("/fortune", {
        method: "POST",
        headers: {"Content-Type":"application/json", "Cache-Control":"no-cache"},
        body: JSON.stringify(body)
      });
      const js = await r.json();
      if (!js.ok) throw new Error(js.error || "å ã„ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");

      const d = js.data || {};
      const title = esc(d.title || "");
      const lead  = esc(d.lead  || "");
      const over  = beautify(d.overview);
      const advice = (Array.isArray(d.advice)?d.advice:[]).map(x=>`<li>${esc(x)}</li>`).join("");
      const warns  = (Array.isArray(d.warnings)?d.warnings:[]).map(x=>`<li>${esc(x)}</li>`).join("");
      const kw     = (Array.isArray(d.keywords)?d.keywords:[]).slice(0,6).map(k=>`<span class="tag">${esc(k)}</span>`).join("");

      const color = esc(d.lucky_color || "-");
      const num   = esc(d.lucky_number || "-");
      const days  = Array.isArray(d.chance_days) ? d.chance_days : [];
      const chance = days.map(s=>`<span class="pill">ãƒãƒ£ãƒ³ã‚¹ã®æ—¥ï¼š${esc(s)}</span>`).join(" ");

      elRes.innerHTML = `
        <div class="card" style="margin-top:16px">
          <div class="box">
            <div class="res-title">${title}</div>
            <div class="lead">${lead}</div>
            <div>${over}</div>

            ${warns ? `
            <div class="bullet alert">
              <b>æ³¨æ„ã—ã¦ãŠããŸã„ã“ã¨</b>
              <ul class="list">${warns}</ul>
            </div>` : ""}

            ${advice ? `
            <div class="bullet" style="margin-top:12px">
              <b>${d.tone==="ura" ? "è£ãƒ¢ãƒ¼ãƒ‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆã‚ºãƒãƒƒã¨ã„ãã§ï¼‰" : "ã‚¢ãƒ‰ãƒã‚¤ã‚¹"}</b>
              <ul class="list">${advice}</ul>
            </div>` : ""}

            <div class="kvs" style="margin-top:12px">
              <span class="pill">ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ï¼š${color}</span>
              <span class="pill">ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼ï¼š${num}</span>
              ${chance}
            </div>

            ${kw ? `<div class="kvs" style="margin-top:8px">${kw}</div>` : ""}
          </div>
        </div>
      `;

      // ===== 2é€±é–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ5ã‚¢ã‚¤ã‚³ãƒ³åˆ¤å®šä»˜ãï¼‰ =====
      const today = new Date(); today.setHours(0,0,0,0);

      // å„ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚³ã‚¢é–¢æ•°
      const fAll   = scoreFactory(birth, 111);
      const fLove  = scoreFactory(birth, 237);
      const fMoney = scoreFactory(birth, 353);
      const fWork  = scoreFactory(birth, 479);

      // 14æ—¥åˆ†ä½œæˆ
      const bio = Array.from({length:14},(_,i)=>{
        const date = toYMD(addDays(today,i));
        const sAll   = fAll(i);
        const sLove  = fLove(i);
        const sMoney = fMoney(i);
        const sWork  = fWork(i);
        const {icon, label} = pickIcon(date, sAll, sLove, sMoney, sWork);
        return { date, sAll, sLove, sMoney, sWork, icon, label };
      });

      const weekday = s => new Date(`${s}T00:00:00`).getDay();
      const pad = weekday(bio[0].date);
      const classByAll = s => s>=80?"s-good": s>=60?"s-mid":"s-low";
      const pretty = s=>{ const d=new Date(`${s}T00:00:00`); return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,"0")}`; };

      daysWrap.innerHTML = (pad?`<div style="grid-column:span ${pad}"></div>`:"") + bio.map((x,i)=>{
        const pastel = [ "var(--pastel1)", "var(--pastel2)", "var(--pastel3)", "var(--pastel4)" ][ i % 4 ];
        return `
        <div class="cell" style="background:linear-gradient(180deg, ${pastel}1f, rgba(0,0,0,.12));" title="${esc(x.label)}">
          <div class="date">
            <span>${pretty(x.date)}</span>
            <span class="emoji" aria-label="${esc(x.label)}">${x.icon}</span>
          </div>
          <div class="score ${classByAll(x.sAll)}">å…¨ä½“ï¼š${Math.round(x.sAll)}</div>
        </div>`;
      }).join("");
      const lastPad = (7 - ((pad + bio.length) % 7)) % 7;
      if(lastPad) daysWrap.insertAdjacentHTML("beforeend", `<div style="grid-column:span ${lastPad}"></div>`);
      bioCard.style.display = "";
    }catch(e){
      elRes.innerHTML = `
        <div class="card" style="margin-top:16px">
          <div class="box">
            <div class="lead" style="color:var(--warn)">é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>
            <pre class="sec" style="white-space:pre-wrap">${esc(e.message || e)}</pre>
          </div>
        </div>
      `;
    }finally{
      elRun.disabled = false;
      elRun.textContent = "å ã†ï¼ï¼ˆçµæœã‚’è¡¨ç¤ºï¼‰";
    }
  });
</script>
</body>
</html>
